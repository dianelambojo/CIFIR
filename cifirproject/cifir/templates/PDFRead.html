{% extends "base.html" %} {% load static %} {% block extrascriptheader %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.min.js"
    integrity="sha512-U5C477Z8VvmbYAoV4HDq17tf4wG6HXPC6/KM9+0/wEXQQ13gmKY2Zb0Z2vu0VNUWch4GlJ+Tl/dfoLOH4i2msw==" crossorigin="anonymous"
    referrerpolicy="no-referrer"></script>


{% endblock extrascriptheader %} {% block content %}
<div class="container-fluid"> <br>
  <div class="card">
    <div class="header-fixed" style="justify-content: space-between; padding: 1rem; display: inline-block;text-align: center;">
      {% for book in books %}
      <span style="padding-left: 1em; padding-right: 2em; font-weight: bold">
        <i class="fas fa-book"></i>
        {{book.title}}
        <p id="book1" hidden>{{ book.file }}</p>
      </span>
      <!-- TABLE OF CONTENTS -->
      <span class="text-right">
      <span id="current_page">0 of 0</span>
      <!-- END TABLE OF CONTENTS -->

      <!-- SEARCH, BOOKMARK, CHANGE FONT, FONT SIZE -->
        <!-- <span class="field-search">
          <input class="input-search" type="text" name="search" id="input-search" on/>
          <i class="fas fa-search icon-search" id="btn-search" onclick="search()"></i>
        </span>  -->
        <form method="POST" enctype="multipart\form-data" id='bookmark-submit'> 
          {% csrf_token %}
          <button type="submit" class="fas fa-bookmark icon-link icon-link-icon" style="padding-left: .5em;" id="add-bookmark" name="add-bookmark"></button>
          <input type="text" id="bookmarkId" name="bookmarkId" hidden>
          <input type="text" id="bookmarkIndex" name="bookmarkIndex" hidden>
          <input type="text" id="currentBook" name="currentBook" value="{{ book.id }}" hidden>
          <input type="text" value="{{ currentPage }}" id="current-page" hidden>
        </form>

        <button style="border:none; color: none;" data-toggle="modal" data-target="#bookmarkModal"><i class="fas fa-bars icon-link icon-link-icon"></i></button>

        <div class="modal fade" id="bookmarkModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Bookmarks</h5>
              
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body" style="overflow-y: scroll; height: 500px;">
              <div id="bookmarksView" class="view">
                <div id="bookmarksView" class="view">
                  <h6>{{ book.title }}</h6>
                <!-- <ul id="bookmarks"> Bookmarks </ul> -->
                <!-- <h6>Bookmarks</h6> -->
                  <!-- <div class="bookmark-items" id="bookmark-items"> -->
                  <ul style="display: table; margin: 0 auto;">
                  {% for bookmark in allBookmarks %}
                    <!-- <button class="child child{{ bookmark.id }}" id="{{ bookmark.id }}" value="{{ bookmark.id }}"> Index: {{ bookmark.id }} </button> -->
                    <!-- <input name="{{ bookmark.page_index  }}" value="Index: {{ bookmark.page_index }}"/> -->
                  <!-- <li style="display:block"> <a id="bookmark-items"> </a></li> -->
                    <!-- <input type="text" id="x" value="{{ bookmark.id }}"> --> 
                    <!-- <button id="bookmark-items" value='{{ bookmark.bookpage }}'> Index: {{ bookmark.page_index }} </button> -->
                    <li style="display: block;">
                      <div style="margin-bottom: 5px;">
                        <button style="width: 150%;" class="mark" id="bookmark-items{{ bookmark.id }}" value='{{ bookmark.bookpage }}'> <i class="fa fa-bookmark" style="padding-right: 5px; color: darkred;"></i> <span style="font-weight: bold;">  Page {{ bookmark.page_index }} </span></button>
                      </div>
                    </li>
                  {% endfor %}
                  </ul>
                  <!-- </div> -->
              </div>
              </div>
            </div>
          </div>
        </div>
      </div>
        <!-- <i class="far fa-bookmark icon-link icon-link-icon" onclick="bookmarkBook('{{book.id}}')"></i> -->

        <!-- <span style="padding-left:1em;">
        <select id ="fonts">
          <option value="1">Arial</option>
          <option value="2">Verdana</option>
          <option value="3">Times New Roman</option>
          <option value="4">Courier New</option>
        </select>
        </span> -->

      <span style="padding-left: 0em;">
        <a class="btn" id="increaseFont">
          <span class="icon-font"><i class="fas fa-caret-up icon-link icon-link-icon"></i></span>
        </a>
        <span id="zoomValue">100%</span>
        <a class="btn" id="decreaseFont">
          <span class="icon-font"><i class="fas fa-caret-down icon-link icon-link-icon"></i></span>
        </a>
      </span>
    
      </span>
      <!-- SEARCH, BOOKMARK, CHANGE FONT, FONT SIZE - END-->
      {% endfor %}
    </div>
     <!-- NEXT , PREVIOUS BUTTONS -->
      <a id="prev" href="#prev" class="arrow">‹</a>
      <a id="next" href="#next" class="arrow">›</a>

      <!-- READER -->
    <div class="container card-body">
      <div class="row">
        <div id="viewer" class="spreads col-lg-12" style="overflow: auto; max-width: 1024px; max-height: 1024px;
          text-align: center;">
          <main>
            <h3 hidden>Open a PDF file</h3>
            <canvas class="pdf-viewer hidden">

            </canvas>
          </main>
        </div>
       

          <li hidden>
            
            <span id="zoomValue">100%</span>
            <input type="range" id="zoom" name="cowbell" min="100" max="300" value="100" step="25" disabled>
          </li>
        </ul>

          </div>
        </div>
        <!-- TTS -->
        
        <div>
          <form method='POST' action="" enctype="multipart/form-data">
            {% csrf_token %}
            <button id="click-me" name="click-me" class="btn btn-lg btn-primary " style="padding: 1px 1px; 
                    margin-left: 7rem;
                    background-color:#800000;
                    color: #ffd700;
                    font-size:1em;
                    font-weight: bold;
                    " type="submit">TTS</button>
          </form>
        </div>

        
      </div>
    </div>

  
{% endblock content %} {% block extrascriptfooter %}

<script defer>

  //--- SEARCH *NOT YET FINISHED* ---//
  // var input = document.getElementById("input-search");
  // Execute a function when the user releases a key on the keyboard
  
  // input.addEventListener("keyup", function (event) {
  //   // Number 13 is the "Enter" key on the keyboard
  //   if (event.keyCode === 13) {
  //     console.log("object");
  //     // Cancel the default action, if needed
  //     event.preventDefault();
  //     // Trigger the button element with a click
  //     document.getElementById("btn-search").click();
  //   }
  // });

  // function search() {
  //   alert("search");
  // }
  //--- END OF SEARCH ---//


  console.log('hellooo')
  var count = 0;
  var x = 150;
  const zoomButton = document.getElementById('zoom');
  const currentPage = document.getElementById('current_page');
  const viewer = document.querySelector('.pdf-viewer');
  let currentPDF = {}

function resetCurrentPDF() {
  currentPDF = {
    file: null,
    countOfPages: 0,
    currentPage: 1,
    zoom: 1.5
  }
}


var bookElement = document.getElementById("book1");

var url = window.location.protocol + "//" + window.location.hostname;
  if (window.location.port) url += ":" + window.location.port;

  fetch(url + "/media/" + bookElement.innerHTML)
    .then((response) => response.blob())
    .then(function (myBlob) {
      console.log(myBlob);
      if (myBlob.type == 'application/pdf') {
    const reader = new FileReader();
    reader.readAsDataURL(myBlob);
    reader.onload = () => {
      loadPDF(reader.result);
      zoomButton.disabled = false;
    }
  }
  else {
    console.log("The file you are trying to open is not a pdf file!")
  }
    });



zoomButton.addEventListener('input', () => {
  if (currentPDF.file) {
    document.getElementById('zoomValue').innerHTML = zoomButton.value + "%";
    currentPDF.zoom = parseInt(zoomButton.value) / 100;
    renderCurrentPage();
  }
});

document.getElementById('next').addEventListener('click', () => {
  const isValidPage = currentPDF.currentPage < currentPDF.countOfPages;
  if (isValidPage) {
    currentPDF.currentPage += 1;
    renderCurrentPage();
  }
});

document.getElementById('prev').addEventListener('click', () => {
  const isValidPage = currentPDF.currentPage - 1 > 0;
  if (isValidPage) {
    currentPDF.currentPage -= 1;
    renderCurrentPage();
  }
});

// document.getElementById('add-bookmark').addEventListener('click', () =>{
//   const bookMark = currentPDF.currentPage;

//   console.log("Bookmark button clicked");

//   var link = document.createElement('button');
//   link.innerHTML = "Page:" +bookMark;
//   document.getElementById("bookmark-items").appendChild(link)

//   link.addEventListener("click", function(event){
//               // var cfi = href;
//               console.log(bookMark);
//               currentPDF.currentPage = bookMark;
//               renderCurrentPage();
//               // event.preventDefault();
//           }, false);
// })

document.addEventListener('keydown',(event) => {
  var code = event.keyCode;
  // console.log(code);

  if(code == 37) {
    console.log('key left is pressed');
    const isValidPage = currentPDF.currentPage < currentPDF.countOfPages;
          if (isValidPage) {
            currentPDF.currentPage += 1;
            renderCurrentPage();
          }
  }

  if(code == 39) {
    console.log('key right is pressed');
    const isValidPage = currentPDF.currentPage < currentPDF.countOfPages;
          if (isValidPage) {
            currentPDF.currentPage += 1;
            renderCurrentPage();
          }
  }
})



//BOOKMARK
     var saveBookMark = function () {
        console.log("bookmark clicked");

        var thispage = currentPDF.currentPage;
        console.log(thispage);
        document.getElementById('bookmarkId').value = thispage;


        // var spineItem = book.spine.get(cfi);
        // var tocItem;
        // if (spineItem.index in book.navigation.toc) {
        //   tocItem = book.navigation.toc[spineItem.href];
        //   // link.textContent = "Page: "+spineItem.href;
        //   //bookmarkLink
        //   console.log(href);
        //   document.getElementById('bookmarkId').value =  cfi;
        //   document.getElementById('bookmarkIndex').value = index;
        //   console.log("tocitem", tocItem);
        //   console.log("spine" ,spineItem);
        // } 

  //END-BOOKMARK
  }

  $(".mark").on("click", function(e) {
      console.log('goto this bookmark')

      console.log($(this).attr('id'));

      var id = $(this).attr('id');
      console.log('ID: '+id);

      var newLoc = document.getElementById(id).value;

      console.log(newLoc);
      const isValidPage = newLoc < currentPDF.countOfPages;
        if (isValidPage) {
          currentPDF.currentPage = Number(newLoc);
          renderCurrentPage();
        }
  });

addBookMarkBtn = document.getElementById('add-bookmark');
addBookMarkBtn.addEventListener("click",saveBookMark);

var addBookMark = document.getElementById('bookmark-submit');

addBookMark.onsubmit = function(){
  // console.log("hello submit");

  setTimeout(() => {
    // console.log("hello sad");
    window.location.reload();


    console.log('reload');
    var lastBookmarked = document.getElementById("current-page").value;
    console.log(lastBookmarked);

  }, 500);
};

function loadPDF(data) {
  const pdfFile = pdfjsLib.getDocument(data);
  resetCurrentPDF();
  pdfFile.promise.then((doc) => {
    currentPDF.file = doc;
    currentPDF.countOfPages = doc.numPages;
    viewer.classList.remove('hidden');
    document.querySelector('h3').classList.add("hidden");
    renderCurrentPage();

    var lastBookmarked = document.getElementById("current-page").value;
    currentPDF.currentPage = Number(lastBookmarked);
    renderCurrentPage();
    
  });

}

function renderCurrentPage() {
  currentPDF.file.getPage(currentPDF.currentPage).then((page) => {
    var context = viewer.getContext('2d');
    var viewport = page.getViewport({ scale: currentPDF.zoom, });
    viewer.height = viewport.height;
    viewer.width = viewport.width;

    var renderContext = {
      canvasContext: context,
      viewport: viewport
    };
    page.render(renderContext);
  });
  currentPage.innerHTML = currentPDF.currentPage + ' of ' + currentPDF.countOfPages;
}



    //changeFont();
    // rendition.display();
    document.getElementById("increaseFont").addEventListener("click", increaseFontSize);
    document.getElementById("decreaseFont").addEventListener("click", decreaseFontSize);
    // document.getElementById("fonts").addEventListener('change', changeFont);


  //CHANGE FONT FUNCTIONS
    function increaseFontSize() {
    console.log("click");
    if (currentPDF.file) {
      x+=25;
      count*=x;
      document.getElementById('zoomValue').innerHTML = x + "%";
      currentPDF.zoom = parseInt(x) / 100;
      renderCurrentPage();
      count++;
    }
    }

    function decreaseFontSize() {
       console.log("click");
    if (currentPDF.file) {
      x-=25;
      count*=x;
      document.getElementById('zoomValue').innerHTML = x + "%";
      currentPDF.zoom = parseInt(x) / 100;
      renderCurrentPage();
      count--;
    }
    }

    function changeFont() {
      if(document.getElementById("fonts").value =="1"){
        console.log("changed");
        rendition.themes.default({
          h1: {
            'font-family': 'Arial',
          },
          h2: {
            'font-family': 'Arial',
          },
          h3: {
            'font-family': 'Arial',
          },
          h4: {
            'font-family': 'Arial',
          },
          h5: {
            'font-family': 'Arial',
          },
          h6: {
            'font-family': 'Arial',
          },
          div: {
            'font-family': 'Arial',
          },
          p: {
            'font-family': 'Arial',
          },
    });
      }
      else if(document.getElementById("fonts").value =="2"){
        console.log("changed");
        rendition.themes.default({
          h1: {
            'font-family': 'Verdana',
          },
          h2: {
            'font-family': 'Verdana',
          },
          h3: {
            'font-family': 'Verdana',
          },
          h4: {
            'font-family': 'Verdana',
          },
          h5: {
            'font-family': 'Verdana',
          },
          h6: {
            'font-family': 'Verdana',
          },
          div: {
            'font-family': 'Verdana',
          },
          p: {
            'font-family': 'Verdana',
          },
    });
      }
      else if(document.getElementById("fonts").value =="3"){
        console.log("changed");
        rendition.themes.default({
          h1: {
            'font-family': 'Times New Roman',
          },
          h2: {
            'font-family': 'Times New Roman',
          },
          h3: {
            'font-family': 'Times New Roman',
          },
          h4: {
            'font-family': 'Times New Roman',
          },
          h5: {
            'font-family': 'Times New Roman',
          },
          h6: {
            'font-family': 'Times New Roman',
          },
          div: {
            'font-family': 'Times New Roman',
          },
          p: {
            'font-family': 'Times New Roman',
          },
    });
      }
      else if(document.getElementById("fonts").value =="4"){
        console.log("changed");
        rendition.themes.default({
          h1: {
            'font-family': 'Courier New',
          },
          h2: {
            'font-family': 'Courier New',
          },
          h3: {
            'font-family': 'Courier New',
          },
          h4: {
            'font-family': 'Courier New',
          },
          h5: {
            'font-family': 'Courier New',
          },
          h6: {
            'font-family': 'Courier New',
          },
          div: {
            'font-family': 'Courier New',
          },
          p: {
            'font-family': 'Courier New',
          },
    });
      }
    }
    //CHANGE FONT FUNCTIONS END


 
  
    

    

  // function bookmarkBook(book_id) {
  //   console.log("test");
  //   console.log(book_id);
  //   // post('{% url "cifir:epub_view" %}', {
  //   //   book_id,
  //   //   csrfmiddlewaretoken: "{{csrf_token}}",
  //   // });
  // }

  function post(path, params, method = "post") {
    const form = document.createElement("form");
    form.method = method;
    form.action = path;

    for (const key in params) {
      if (params.hasOwnProperty(key)) {
        const hiddenField = document.createElement("input");
        hiddenField.type = "hidden";
        hiddenField.name = key;
        hiddenField.value = params[key];

        form.appendChild(hiddenField);
      }
    }
    document.body.appendChild(form);
    form.submit();
  }


</script>
{% endblock extrascriptfooter %}
