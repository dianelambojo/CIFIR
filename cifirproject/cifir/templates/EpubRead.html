{% extends "base.html" %} {% load static %} {% block extrascriptheader %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>

{% endblock extrascriptheader %} {% block content %}
<div class="container-fluid"> <br>
  <div class="card">
    <div class="header-fixed">
      {% for book in books %}
      <span style="padding-left: 10em;">
        <i class="fas fa-book"></i>
        {{book.title}}
        <p id="book1" hidden>{{ book.file }}</p>
        <p id="book_id" hidden>{{ book.id }}</p>
      </span>
      <!-- TABLE OF CONTENTS -->
      <span class="text-right">
      <select id="toc" style="margin-right: 5em;"></select>
      <!-- END TABLE OF CONTENTS -->

      

      <!-- SEARCH, BOOKMARK, CHANGE FONT, FONT SIZE -->
        <!-- <span class="field-search">
          <input class="input-search" type="text" name="search" id="input-search" on/>
          <i class="fas fa-search icon-search" id="btn-search" onclick="search()"></i>
        </span>  -->
        <i class="fas fa-bookmark icon-link icon-link-icon" style="padding-left: .5em;" id="add-bookmark"></i>
        <!-- <i class="far fa-bookmark icon-link icon-link-icon"></i> -->
        <button style="border:none; color: none;" data-toggle="modal" data-target="#bookmarkModal"><i class="fas fa-bars icon-link icon-link-icon"></i></button>

        <div class="modal fade" id="bookmarkModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Bookmarks</h5>
              
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div id="bookmarksView" class="view">
                <!-- <ul id="bookmarks"> Bookmarks </ul> -->
                <h6>Bookmarks</h6>
                {% for bookmark in allBookmarks %}
                  <!-- <li style="display:block"> <a id="bookmark-items"> </a></li> -->
                    <!-- <input type="text" id="x" value="{{ bookmark.id }}"> -->
                    <button id="bookmark-items" value='{{ bookmark.bookpage }}' onclick="getID(this.id)">Page: {{ bookmark.page_index }} </button>
                    <!-- <button id="{{ bookmark.bookpage }}" value='{{ bookmark.bookpage }}' onclick="getID(this.id)"> {{ bookmark.bookpage }} </button> -->
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>

        <span style="padding-left:1em;">
        <select id ="fonts">
          <option value="1">Arial</option>
          <option value="2">Verdana</option>
          <option value="3">Times New Roman</option>
          <option value="4">Courier New</option>
        </select>
        </span>

      <span style="padding-left: 1em;">
        <a class="btn" id="increaseFont">
          <span class="icon-font"><i class="fas fa-caret-up icon-link icon-link-icon"></i></span>
        </a>
        <a class="btn" id="decreaseFont">
          <span class="icon-font"><i class="fas fa-caret-down icon-link icon-link-icon"></i></span>
        </a>
      </span>
    
      </span>
      <!-- SEARCH, BOOKMARK, CHANGE FONT, FONT SIZE - END-->
      {% endfor %}
    </div>

    <!-- NEXT , PREVIOUS BUTTONS -->
      <a id="prev" href="#prev" class="arrow">‹</a>
      <a id="next" href="#next" class="arrow">›</a>
   <!-- READER -->

    <div class="container card-body">
      <div class="row">
        <div id="viewer" class="spreads" >
        </div>
      </div>
    </div>
    
    
      <div>
        <form method='POST' action="" enctype="multipart/form-data">
            {% csrf_token %}
            <button id="click-me" name="click-me" class="btn btn-lg btn-primary" type="submit" 
            style="padding: 1px 1px; 
            margin-left: 7rem;
            background-color:#800000;
            color: #ffd700;
            font-size:1em;
            font-weight: bold;
            ">TTS</button>
        </form>
    </div>
  </div>
</div>


{% endblock content %} {% block extrascriptfooter %}

<script defer>

  //--- SEARCH *NOT YET FINISHED* ---//
  // var input = document.getElementById("input-search");
  // // Execute a function when the user releases a key on the keyboard
  
  // input.addEventListener("keyup", function (event) {
  //   // Number 13 is the "Enter" key on the keyboard
  //   if (event.keyCode === 13) {
  //     console.log("object");
  //     // Cancel the default action, if needed
  //     event.preventDefault();
  //     // Trigger the button element with a click
  //     document.getElementById("btn-search").click();
  //   }
  // });

  function search() {
    alert("search");
  }
  //--- END OF SEARCH ---//

  // Epub Reader Library
  // https://github.com/futurepress/epub.js


  var book = ePub();
  var rendition;

  //fontvariables
  var x = 15;
  var count = 0;

  //book 
  var inputElement = document.getElementById("input");
  var bookElement = document.getElementById("book1");
  var bookID = document.getElementById("book_id");

  var url = window.location.protocol + "//" + window.location.hostname;
  if (window.location.port) url += ":" + window.location.port;

  fetch(url + "/media/" + bookElement.innerHTML)
    .then((response) => response.blob())
    .then(function (myBlob) {
      console.log(myBlob);
      var reader = new FileReader();
      reader.onload = openBook;
      reader.readAsArrayBuffer(myBlob);
      console.log("done");
    });

  function openBook(e) {
    var bookData = e.target.result;
    var params = URLSearchParams && new URLSearchParams(document.location.search.substring(1));
    var url = params && params.get("url") && decodeURIComponent(params.get("url"));
    var currentSectionIndex = (params && params.get("loc")) ? params.get("loc") : undefined;

    book.open(bookData, "binary");

    var rendition = book.renderTo("viewer", {
      width: "100%",
      height: 600,
      spread: "always"
    });

    rendition.display(currentSectionIndex);

    book.ready.then(function() {

      var next = document.getElementById("next");

      next.addEventListener("click", function(e){
        book.package.metadata.direction === "rtl" ? rendition.prev() : rendition.next();
        e.preventDefault();
      }, false);

      var prev = document.getElementById("prev");
      prev.addEventListener("click", function(e){
        book.package.metadata.direction === "rtl" ? rendition.next() : rendition.prev();
        e.preventDefault();
      }, false);

      var keyListener = function(e){

        // Left Key
        if ((e.keyCode || e.which) == 37) {
          book.package.metadata.direction === "rtl" ? rendition.next() : rendition.prev();
        }

        // Right Key
        if ((e.keyCode || e.which) == 39) {
          book.package.metadata.direction === "rtl" ? rendition.prev() : rendition.next();
        }

      };

      rendition.on("keyup", keyListener);
      document.addEventListener("keyup", keyListener, false);

      //BOOKMARK
       var saveBookMark = function () {
          console.log("bookmark clicked");
          console.log(rendition.currentLocation());

          var loc = rendition.currentLocation();
          var cfi = loc.start.cfi
          var index = loc.start.index
          var href = loc.start.href

          console.log(href);
          
          var link = document.createElement('button');
          // var linkText = document.createTextNode("title");
          // link.appendChild(linkText);
          // link.title = "title";
          link.innerHTML = href;
          // link.innerHTML = href;
          document.getElementById("bookmark-items").appendChild(link)

          var spineItem = book.spine.get(cfi);
          var tocItem;
          if (spineItem.index in book.navigation.toc) {
            tocItem = book.navigation.toc[spineItem.href];
            link.textContent = "Page: "+spineItem.href;
            console.log("tocitem", tocItem);
            console.log("spine" ,spineItem);
          } else {
            link.textContent = cfi;
          }

          link.addEventListener("click", function(event){
              // var cfi = href;
              console.log(cfi);
              rendition.display(cfi);

              // event.preventDefault();
          }, false);

          

       


          

    //END-BOOKMARK
    }
    var addBookMark = document.getElementById('add-bookmark');
        addBookMark.addEventListener("click", saveBookMark);
  })

    var title = document.getElementById("title");

    rendition.on("rendered", function(section){
      var current = book.navigation && book.navigation.get(section.href);

      if (current) {
        var $select = document.getElementById("toc");
        var $selected = $select.querySelector("option[selected]");
        if ($selected) {
          $selected.removeAttribute("selected");
        }

        var $options = $select.querySelectorAll("option");
        for (var i = 0; i < $options.length; ++i) {
          let selected = $options[i].getAttribute("ref") === current.href;
          if (selected) {
            $options[i].setAttribute("selected", "");
          }
        }
      }

    });

    rendition.on("relocated", function(location){
      console.log(location);

      var next = book.package.metadata.direction === "rtl" ?  document.getElementById("prev") : document.getElementById("next");
      var prev = book.package.metadata.direction === "rtl" ?  document.getElementById("next") : document.getElementById("prev");

      // if (location.atEnd) {
      //   next.style.visibility = "hidden";
      // } else {
      //   next.style.visibility = "visible";
      // }

      // if (location.atStart) {
      //   prev.style.visibility = "hidden";
      // } else {
      //   prev.style.visibility = "visible";
      // }

    });

    rendition.on("layout", function(layout) {
      let viewer = document.getElementById("viewer");

      if (layout.spread) {
        viewer.classList.remove('single');
      } else {
        viewer.classList.add('single');
      }
    });

    window.addEventListener("unload", function () {
      console.log("unloading");
      this.book.destroy();
    });

    book.loaded.navigation.then(function(toc){
      var $select = document.getElementById("toc"),
          docfrag = document.createDocumentFragment();

      toc.forEach(function(chapter) {
        var option = document.createElement("option");
        option.textContent = chapter.label;
        option.setAttribute("ref", chapter.href);

        docfrag.appendChild(option);
      });

      $select.appendChild(docfrag);

      $select.onchange = function(){
          var index = $select.selectedIndex,
              url = $select.options[index].getAttribute("ref");
          rendition.display(url);
          return false;
      }; 
    });



    changeFont();
    // rendition.display();
    document.getElementById("increaseFont").addEventListener("click", increaseFontSize);
    document.getElementById("decreaseFont").addEventListener("click", decreaseFontSize);
    document.getElementById("fonts").addEventListener('change', changeFont);


  //CHANGE FONT FUNCTIONS
    function increaseFontSize() {
    console.log("click");
      x+=10;
      count*=x;
      rendition.themes.default({
      h1: {
        'font-size':x+'px',
        color: 'purple'
      },
      h2: {
        'font-size':x+'px',
        color: 'purple'
      },
      h3: {
        'font-size':x+'px',
        color: 'purple'
      },
      h4: {
        'font-size':x+'px',
        color: 'purple'
      },
      h5: {
        'font-size':x+'px',
        color: 'purple'
      },
      h6: {
        'font-size':x+'px',
        color: 'purple'
      },
      div: {
        'font-size':x+'px',
      },
      p: {
        "margin": '10px',
        'font-size': '20px',
      },
    });

      // rendition.display();
      count++;
    }

    function decreaseFontSize() {
      console.log("click");
      x-=10;
      count*=x;
      rendition.themes.default({
      h1: {
        'font-size':x+'px',
        color: 'purple'
      },
      h2: {
        'font-size':x+'px',
        color: 'purple'
      },
      h3: {
        'font-size':x+'px',
        color: 'purple'
      },
      h4: {
        'font-size':x+'px',
        color: 'purple'
      },
      h5: {
        'font-size':x+'px',
        color: 'purple'
      },
      h6: {
        'font-size':x+'px',
        color: 'purple'
      },
      div: {
        'font-size':x+'px',
      },
      p: {
        "margin": '10px',
        'font-size': '10px',
      },
    });

      // rendition.display();
      count++;
    }

    function changeFont() {
      if(document.getElementById("fonts").value =="1"){
        console.log("changed");
        rendition.themes.default({
          h1: {
            'font-family': 'Arial',
          },
          h2: {
            'font-family': 'Arial',
          },
          h3: {
            'font-family': 'Arial',
          },
          h4: {
            'font-family': 'Arial',
          },
          h5: {
            'font-family': 'Arial',
          },
          h6: {
            'font-family': 'Arial',
          },
          div: {
            'font-family': 'Arial',
          },
          p: {
            'font-family': 'Arial',
          },
    });
      }
      else if(document.getElementById("fonts").value =="2"){
        console.log("changed");
        rendition.themes.default({
          h1: {
            'font-family': 'Verdana',
          },
          h2: {
            'font-family': 'Verdana',
          },
          h3: {
            'font-family': 'Verdana',
          },
          h4: {
            'font-family': 'Verdana',
          },
          h5: {
            'font-family': 'Verdana',
          },
          h6: {
            'font-family': 'Verdana',
          },
          div: {
            'font-family': 'Verdana',
          },
          p: {
            'font-family': 'Verdana',
          },
    });
      }
      else if(document.getElementById("fonts").value =="3"){
        console.log("changed");
        rendition.themes.default({
          h1: {
            'font-family': 'Times New Roman',
          },
          h2: {
            'font-family': 'Times New Roman',
          },
          h3: {
            'font-family': 'Times New Roman',
          },
          h4: {
            'font-family': 'Times New Roman',
          },
          h5: {
            'font-family': 'Times New Roman',
          },
          h6: {
            'font-family': 'Times New Roman',
          },
          div: {
            'font-family': 'Times New Roman',
          },
          p: {
            'font-family': 'Times New Roman',
          },
    });
      }
      else if(document.getElementById("fonts").value =="4"){
        console.log("changed");
        rendition.themes.default({
          h1: {
            'font-family': 'Courier New',
          },
          h2: {
            'font-family': 'Courier New',
          },
          h3: {
            'font-family': 'Courier New',
          },
          h4: {
            'font-family': 'Courier New',
          },
          h5: {
            'font-family': 'Courier New',
          },
          h6: {
            'font-family': 'Courier New',
          },
          div: {
            'font-family': 'Courier New',
          },
          p: {
            'font-family': 'Courier New',
          },
    });
      }
    }
    //CHANGE FONT FUNCTIONS END

  }

 
  
    

    

  // function bookmarkBook(book_id) {
  //   console.log("test");
  //   console.log(book_id);
  //   // post('{% url "cifir:epub_view" %}', {
  //   //   book_id,
  //   //   csrfmiddlewaretoken: "{{csrf_token}}",
  //   // });


     
  // }

  function post(path, params, method = "post") {
    const form = document.createElement("form");
    form.method = method;
    form.action = path;

    for (const key in params) {
      if (params.hasOwnProperty(key)) {
        const hiddenField = document.createElement("input");
        hiddenField.type = "hidden";
        hiddenField.name = key;
        hiddenField.value = params[key];

        form.appendChild(hiddenField);
      }
    }
    document.body.appendChild(form);
    form.submit();
  }




</script>
{% endblock extrascriptfooter %}
